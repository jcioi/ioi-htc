upstream backend_server {
  server <%= listen_spec %>;
  keepalive 4;
}

geo $ioi_internal {
  proxy 127.0.0.1/32;
  proxy 10.18.192.0/18;
  proxy_recursive;

  default 0;
  # apne1 VPC
  10.18.192.0/18 1;
}

geo $ioi_internal_single {
  default 0;
  # apne1 VPC
  10.18.192.0/18 1;
}

server {
  listen 80;

  set $request_proto "$http_x_forwarded_proto";
  if ($request_proto = "") {
    set $request_proto "http";
  }
  set $internal_xff_cond "$ioi_internal_single,$http_x_internal_forwarded_proto";
  if ($internal_xff_cond ~ "^1,." ) {
    set $request_proto "$http_x_internal_forwarded_proto";
  }

  <%- if location_uses_omniauth? -%>
  include /etc/nginx/utils/ngx_omniauth_enable_server.conf;
  <%- end -%>

  <%- if client_max_body_size -%>
  client_max_body_size <%= client_max_body_size %>;
  <%- end -%>

  <%- locations.each do |path, location| -%>
  location <%= path %> {
<%= render_location(listen_spec, location) %>
  }
  <%- end -%>
}
